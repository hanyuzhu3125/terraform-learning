# Terraformの変数

## Terraform における「変数 (input variables)」の役割

Terraform モジュールを “関数” に見立てると、**変数は引数**に相当します。設定値をコードから分離して再利用性・可搬性を高め、モジュールを呼び出す側が値を注入できるようにする仕組みです。

変数の宣言方法と書式は`variables.tf` を参照します。

## 主な引数

| 引数 | 目的 |
| --- | --- |
| `type` | 受け付ける値の型（`string`, `number`, `bool`, `list(string)` など） |
| `default` | デフォルト値を与えると **必須入力ではなく** なる |
| `description` | ドキュメント用途 |
| `validation` | `condition` と `error_message` で独自チェック |
| `sensitive` | `true` にすると plan/apply 出力・状態ファイルで値をマスクする |
| `nullable` | `false` にすると `null` を許さず、`null` が来た場合は `default` を適用する |
| `ephemeral` | 実行時のみ参照し、state には書き込まない一時変数 |

## 機密情報の処理

AWSのアクセスキー、シークレットキーなど機密情報を変数として記載したい場合、**`.tfvars`** というファイルを利用して機密情報を保存します。コードと値を分離し、環境ごとの差分や機密情報を外部化できるのが主な目的です。

Terraform CLI は `plan` や `apply` の起動時に **「変数をどこから、どんな順序で集めるか」** を厳密に定義しています。**`.tfvars`**ファイルはその中の“変数定義ファイル”というレイヤに属し、以下のように処理されます。

---

### 1. いつ読まれるか

1. **構成ファイル解析フェーズの前段階**
    
    CLI はカレントディレクトリ配下のすべての `.tf/ .tf.json` を読み込む前に、まず「入力変数の値をどう埋めるか」を決定します。ここで
    
    - **環境変数 (`TF_VAR_...`)**
    - **`.tfvars`系ファイル**
    - **`var` / `var-file` CLI オプション**
        
        を順にロードし、変数マップを作ります。
        
2. **HCL2 パースと型変換**
    
    `.tfvars`/`.auto.tfvars`/JSON いずれも **HCL2 のサブセット** として解析され、各値は宣言側の `type` に合わせて内部表現（cty タイプ）にキャストされます。
    
    > ここではリソースや他の変数を参照することはできず、純粋なリテラル と一部ファイル/文字列系関数のみ利用可。
    > 
3. **最終的な値が凍結され、評価グラフに注入**
    
    以降のコンフィグ評価や plan 作成では **定数** として扱われます。値そのものは状態ファイルには保存されません（plan ファイルには含まれる）。
    

## Tips

資格情報を含む **`.tfvars`** を Git にプッシュすることは禁止です。

**`.gitgnore`** に追加、または暗号化された **`.tfvars.json`** を使用します。