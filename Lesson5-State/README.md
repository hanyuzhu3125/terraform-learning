# Terraform State

## Terraform Stateとは

Terraform が **インフラの現在（実際に作成されたリソース）** と **コードで定義した理想状態** を突き合わせるために保持するメタデータファイル（`*.tfstate`）です。

簡潔に言えば、「**Terraform が管理対象リソースを把握するための台帳**」です。

### 1. 具体的に何が記録されるか

| 区分 | 例 |
| --- | --- |
| **リソース ID** | `aws_instance.web.id = i-0abc123…` |
| **属性値** | `private_ip = "10.0.1.25"` など |
| **依存関係** | どのリソースがどれに依存するか |
| **バージョン情報** | Terraform のバージョン、provider バージョン |
| **バックエンド設定** | Remote State 使用時の設定メタ |

### 2. なぜ必要か

1. **差分計算 (Plan)**
    
    既存リソースと HCL 定義を比較し、追加・変更・削除を決定。
    
2. **リソース追跡 (Apply/Destroy)**
    
    重複作成を防ぎ、意図しない削除を抑止。
    
3. **インクリメンタル実行**
    
    前回実行からの差分だけを効率的に適用。
    

### 3. 保管場所（バックエンド）

| バックエンド | 特徴 |
| --- | --- |
| **local**（デフォルト） | `terraform.tfstate` がローカルディレクトリに生成 |
| **remote**（S3, GCS, AzRM, Terraform Cloud など） | チーム共有・ロック・バージョン管理が容易 |
| **Terraform Cloud/Enterprise** | 自動バックアップ・強制ロック・可視化 UI |

### 4. 主な操作コマンド

| コマンド | 用途 |
| --- | --- |
| `terraform state list` | ステート内のリソース一覧 |
| `terraform state show <addr>` | 特定リソースの属性確認 |
| `terraform state mv` / `rm` | ステートの手動編集（リネーム・分割など） |
| `terraform refresh` | 実環境とステートの差分を更新 |
| `terraform import` | 既存リソースをステートに取り込む |

### 5. ベストプラクティス

1. **リモートステートを使用**：チーム開発ではローカルファイルを避ける。
2. **暗号化と最小権限**：S3 なら SSE-KMS + IAM でアクセス制御。
3. **バージョン管理**：S3 バージョニングや Terraform Cloud の履歴でロールバック可能に。
4. **CI/CD で plan/apply**：人的ミス低減とロック競合回避。
5. **不要な手動編集を避ける**：`state mv/rm` は最終手段。HCL 変更 → `terraform apply` を基本とする。

### 6. よくある誤解

| 誤解 | 正しい理解 |
| --- | --- |
| **「.tfstate を Git に入れればよい」** | 機密情報を含むため推奨されない。リモートステート + バージョン管理が安全。 |
| **「ステートが壊れたら terraform refresh で元に戻せる」** | 属性は取得できても、失われた依存関係や meta 情報は復旧不可。バックアップ必須。 |
| **「import でコードも自動生成される」** | import はステート登録だけ。HCL は手書きが必要。 |